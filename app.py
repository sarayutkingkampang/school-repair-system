import streamlit as st
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import os
from PIL import Image
import io
import base64
import time # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢

# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Path ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå ---
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
CREDS_PATH = os.path.join(BASE_DIR, 'credentials.json')
LOGO_PATH = os.path.join(BASE_DIR, 'logo.png') # Path ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏•‡πÇ‡∏Å‡πâ
SHEET_NAME = "RepairData"

# ================= ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡πà‡∏≤‡∏á‡πÜ =================

# --- ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô Base64 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Sheets) ---
def process_image(image_file):
    if image_file is None: return ""
    try:
        img = Image.open(image_file)
        img.thumbnail((600, 600)) # ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ
        buffered = io.BytesIO()
        # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô RGB ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ã‡∏ü‡πÄ‡∏õ‡πá‡∏ô JPEG ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏£‡∏π‡∏õ PNG ‡∏û‡∏∑‡πâ‡∏ô‡πÉ‡∏™
        img.convert('RGB').save(buffered, format="JPEG", quality=60)
        return base64.b64encode(buffered.getvalue()).decode()
    except: return ""

# --- ‡πÅ‡∏õ‡∏•‡∏á Base64 ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå) ---
def base64_to_image(base64_string):
    try:
        if not base64_string or len(base64_string) < 100: return None
        img_data = base64.b64decode(base64_string)
        return Image.open(io.BytesIO(img_data))
    except: return None

# --- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ---
def connect_google_sheet():
    if not os.path.exists(CREDS_PATH):
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏Å‡∏∏‡∏ç‡πÅ‡∏à: {CREDS_PATH}")
        return None
    try:
        scope = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']
        creds = ServiceAccountCredentials.from_json_keyfile_name(CREDS_PATH, scope)
        client = gspread.authorize(creds)
        return client.open(SHEET_NAME).sheet1
    except Exception as e:
        st.error(f"‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Sheets ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")
        return None

# --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
def load_data():
    sheet = connect_google_sheet()
    if sheet:
        try:
            data = sheet.get_all_records()
            df = pd.DataFrame(data)
            if 'ID' in df.columns:
                df['ID'] = pd.to_numeric(df['ID'], errors='coerce')
            return df
        except: pass
    return pd.DataFrame()

# --- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ---
def add_request(name, department, issue, img_str):
    sheet = connect_google_sheet()
    if sheet:
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        try:
            all_records = sheet.get_all_values()
            new_id = len(all_records)
        except: new_id = 1
        try:
            sheet.append_row([new_id, timestamp, name, department, issue, '‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß (Pending)', '', img_str])
            return True
        except: pass
    return False

# --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Admin) ---
def update_status(req_id, new_status, repair_note):
    sheet = connect_google_sheet()
    if sheet:
        try:
            cell = sheet.find(str(req_id))
            if cell:
                sheet.update_cell(cell.row, 6, new_status) # Col F
                sheet.update_cell(cell.row, 7, repair_note) # Col G
                return True
        except: pass
    return False

# --- ‡∏•‡∏ö‡∏á‡∏≤‡∏ô (Admin) ---
def delete_request(req_id):
    sheet = connect_google_sheet()
    if sheet:
        try:
            cell = sheet.find(str(req_id))
            if cell:
                sheet.delete_rows(cell.row)
                return True
        except: pass
    return False

# ================= ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏±‡∏Å =================
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° - ‡∏£.‡∏ô.‡∏™.‡πí", layout="wide", page_icon="üõ†Ô∏è")

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö (Header & Logo) ---
col_logo, col_title = st.columns([1, 5])
with col_logo:
    if os.path.exists(LOGO_PATH):
        st.image(LOGO_PATH, width=120) # ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏•‡πÇ‡∏Å‡πâ
    else:
        st.warning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå logo.png")
with col_title:
    st.title("‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£")
    st.subheader("‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏ä‡∏ô‡∏±‡∏ô‡∏ó‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå ‡∏™‡∏≤‡∏°‡πÄ‡∏™‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢ ‡πí")

st.divider()

# --- ‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏ó‡πá‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---
tab1, tab2, tab3 = st.tabs(["üìù ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)", "üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô (Real-time)", "üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)"])

# ================= TAB 1: ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏° =================
with tab1:
    st.header("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°")
    with st.form("repair_form", clear_on_submit=True):
        c1, c2 = st.columns(2)
        with c1:
            name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á")
            dept = st.text_input("‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Ø / ‡πÅ‡∏ú‡∏ô‡∏Å‡∏á‡∏≤‡∏ô / ‡∏´‡πâ‡∏≠‡∏á") 
        with c2:
            issue = st.text_area("‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢ / ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö (‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)")
            uploaded_file = st.file_uploader("‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)", type=['jpg', 'png', 'jpeg'])
        
        st.caption("*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£")
        submitted = st.form_submit_button("üöÄ ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°", type="primary", use_container_width=True)
        
        if submitted:
            if name and issue and dept:
                with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö..."):
                    img_str = process_image(uploaded_file)
                    success = add_request(name, dept, issue, img_str)
                
                if success:
                    st.toast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", icon="üéâ")
                    time.sleep(1)
                    st.rerun()
                else:
                    st.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á")
            else:
                st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡∏ä‡∏∑‡πà‡∏≠, ‡πÅ‡∏ú‡∏ô‡∏Å ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö")

# ================= TAB 2: ‡∏î‡∏π‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô =================
with tab2:
    col_head, col_ref = st.columns([4,1])
    with col_head: st.header("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î")
    with col_ref: 
        if st.button("üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", use_container_width=True): st.rerun()

    df = load_data()
    if not df.empty and 'ID' in df.columns:
        df = df.sort_values(by='ID', ascending=False) # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
        
        for index, row in df.iterrows():
            status = row.get('Status', '‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß (Pending)')
            # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            s_color = "red" if "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß" in status else "green" if "‡πÄ‡∏™‡∏£‡πá‡∏à" in status else "#FF8C00" # ‡∏™‡πâ‡∏°
            s_icon = "üî¥" if "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß" in status else "üü¢" if "‡πÄ‡∏™‡∏£‡πá‡∏à" in status else "üü†"
            
            # ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î
            with st.expander(f"{s_icon} ID: {row.get('ID','-')} | {row.get('Issue','-')} [‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: :{s_color}[{status}]]"):
                c1, c2, c3 = st.columns([2, 2, 1])
                with c1:
                    st.write(f"üë§ **‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:** {row.get('Name','-')}")
                    st.write(f"üè¢ **‡πÅ‡∏ú‡∏ô‡∏Å/‡∏´‡πâ‡∏≠‡∏á:** {row.get('Department','-')}")
                    st.write(f"üïí **‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á:** {row.get('Timestamp','-')}")
                with c2:
                    st.info(f"**üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:** {row.get('Issue','-')}")
                    if row.get('RepairNote'):
                        st.success(f"**üõ†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏≤‡∏á:** {row.get('RepairNote')}")
                with c3:
                    img = base64_to_image(row.get('Image', ''))
                    if img: st.image(img, caption="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô", use_column_width=True)
    else:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")

# ================= TAB 3: Admin (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà) =================
with tab3:
    st.header("üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° (Admin)")
    pwd = st.text_input("üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin", type="password")
    
    if pwd == "1234":
        st.success("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
        st.divider()
        
        if st.button("üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"): st.rerun()
            
        df_admin = load_data()
        if not df_admin.empty and 'ID' in df_admin.columns:
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏≤ ID ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢‡πÜ
            df_admin = df_admin.sort_values(by='ID', ascending=False)
            
            st.write(f"üì∞ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({len(df_admin)} ‡∏á‡∏≤‡∏ô)")
            
            # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡πÉ‡∏ä‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤ Dropdown)
            for i, row in df_admin.iterrows():
                task_id = row['ID']
                status = row.get('Status', '‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß (Pending)')
                s_color = "red" if "‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß" in status else "green" if "‡πÄ‡∏™‡∏£‡πá‡∏à" in status else "orange"
                
                # ‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô
                with st.container(border=True):
                    # ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏≤‡∏ô
                    st.markdown(f"### üÜî {task_id} : {row.get('Issue','-')} (:{s_color}[{status}])")
                    
                    ac1, ac2 = st.columns([3, 1])
                    with ac1:
                        st.write(f"**‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:** {row.get('Name')} ({row.get('Department')}) | **‡πÄ‡∏ß‡∏•‡∏≤:** {row.get('Timestamp')}")
                        # ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÉ‡∏ä‡πâ key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ï‡πà‡∏•‡∏∞ ID ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏µ‡∏Å‡∏±‡∏ô)
                        with st.form(key=f"form_{task_id}"):
                            st.write("üõ†Ô∏è **‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ:**")
                            c_stat, c_note = st.columns(2)
                            with c_stat:
                                # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default ‡∏Ç‡∏≠‡∏á Dropdown ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                                status_options = ["‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß (Pending)", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "‡∏£‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà", "‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"]
                                try: default_ix = status_options.index(status)
                                except: default_ix = 0
                                new_status = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", status_options, index=default_ix, key=f"st_{task_id}")
                            with c_note:
                                new_note = st.text_input("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", value=str(row.get('RepairNote','')), key=f"nt_{task_id}")
                            
                            # ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                            if st.form_submit_button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç", type="primary"):
                                update_status(task_id, new_status, new_note)
                                st.toast(f"‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô ID {task_id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!", icon="‚úÖ")
                                time.sleep(1) # ‡∏£‡∏≠‡πÉ‡∏´‡πâ Toast ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                                st.rerun()

                    with ac2:
                        # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                        img = base64_to_image(row.get('Image', ''))
                        if img: st.image(img, caption="‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô", use_column_width=True)
                        
                        st.divider()
                        # ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡πÉ‡∏™‡πà Popover ‡∏Å‡∏±‡∏ô‡∏°‡∏∑‡∏≠‡∏•‡∏±‡πà‡∏ô)
                        with st.popover("üóëÔ∏è ‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ", use_container_width=True):
                            st.write(f"‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏á‡∏≤‡∏ô ID {task_id}?")
                            if st.button("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö", type="primary", key=f"del_{task_id}"):
                                delete_request(task_id)
                                st.toast(f"‡∏•‡∏ö‡∏á‡∏≤‡∏ô ID {task_id} ‡πÅ‡∏•‡πâ‡∏ß!", icon="üóëÔ∏è")
                                time.sleep(1)
                                st.rerun()
        else:
            st.info("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°")